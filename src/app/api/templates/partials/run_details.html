<div style="display:flex;flex-direction:column;gap:28px;width:100%;max-width:100%;min-width:0;box-sizing:border-box;" data-run-id="{{ run.id }}" data-run-status="{{ run.status }}">
  {% set chunk_stage = run.get_stage('chunking') %}
  {% set pixmap_metrics = run.document.metadata.get('pixmap_metrics') if run.document and run.document.metadata else None %}
  <div style="display:flex;align-items:flex-end;gap:24px;flex-wrap:wrap;width:100%;max-width:100%;min-width:0;box-sizing:border-box;">
    <div>
      <div style="font-size:0.75rem;letter-spacing:0.35em;color:#94a3b8;text-transform:uppercase;">Active run</div>
      <h3 style="margin:6px 0 4px;font-size:1.6rem;">{{ run.filename }}</h3>
      <p style="margin:0;font-size:0.95rem;color:#94a3b8;">Run ID: <code>{{ run.id }}</code></p>
    </div>
    <div style="margin-left:auto;display:flex;gap:18px;font-size:0.95rem;color:#94a3b8;align-items:center;">
      <span>Pages: {{ run.page_count }}</span>
      <span>Chunks: {{ chunk_stage.details.chunk_count if chunk_stage else 0 }}</span>
      <span style="padding:6px 12px;border-radius:999px;border:1px solid rgba(148,163,184,0.3);text-transform:capitalize;">{{ run.status }}</span>
    </div>
  </div>

  {% if run.status == "failed" and run.error_message %}
    <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.4);border-radius:12px;padding:12px;color:#fecdd3;">
      {{ run.error_message }}
    </div>
  {% endif %}

  {% if pixmap_metrics %}
    <section>
      <h4 style="margin-bottom:8px;">Multi-modal parsing metrics</h4>
      <div class="metrics-grid">
        <article class="metric-card">
          <div class="metric-label">Pixmaps generated</div>
          <div class="metric-value">{{ pixmap_metrics.generated or 0 }}</div>
          <div class="metric-subtext">Rendered pages ({{ pixmap_metrics.dpi or 'n/a' }} DPI)</div>
        </article>
        <article class="metric-card">
          <div class="metric-label">Pixmaps attached</div>
          <div class="metric-value">{{ pixmap_metrics.attached or 0 }}</div>
          <div class="metric-subtext">Skipped: {{ pixmap_metrics.skipped or 0 }}</div>
        </article>
        <article class="metric-card">
          <div class="metric-label">Total image size</div>
          {% set total_bytes = pixmap_metrics.total_size_bytes or 0 %}
          <div class="metric-value">{{ '%.1f'|format((total_bytes / 1024) if total_bytes else 0) }} KB</div>
          <div class="metric-subtext">Across attached pixmaps</div>
        </article>
        <article class="metric-card">
          <div class="metric-label">Avg parsing LLM latency</div>
          {% set latency = pixmap_metrics.avg_structured_latency_ms %}
          <div class="metric-value">
            {% if latency %}
              {{ '%.0f'|format(latency) }} ms
            {% else %}
              —
            {% endif %}
          </div>
          <div class="metric-subtext">Mean of structured parser calls</div>
        </article>
      </div>
    </section>
  {% endif %}

  {% if run.file_path and run.document %}
    <div class="two-column">
      <article>
        <h4>Uploaded document preview</h4>
        <iframe
          title="Document preview"
          class="preview"
          src="{{ request.url_for('static', path=run.file_path) }}"
        ></iframe>
      </article>
      <article>
        <h4>Chunk highlights</h4>
        {% set chunks = chunk_stage.details.pages if chunk_stage else [] %}
        {% if chunks %}
          <div class="chunk-list">
            {% for page in chunks %}
              <div class="chunk-card">
                <div style="font-size:0.85rem;color:#94a3b8;">Page {{ page.page_number }} · {{ page.chunk_count }} chunks</div>
                <ul style="list-style:none;padding:0;margin:10px 0 0;display:flex;flex-direction:column;gap:8px;font-size:0.85rem;">
                  {% for chunk in page.chunks[:4] %}
                    <li>
                      <div style="font-family:monospace;font-size:0.75rem;color:#34d399;">{{ chunk.chunk_id[:10] }}…</div>
                      <div style="margin:4px 0;color:#e0f2fe;">{{ chunk.text_preview }}{% if chunk.text_preview|length == 200 %}…{% endif %}</div>
                      <div style="color:#94a3b8;">Offsets {{ chunk.offset[0] }}–{{ chunk.offset[1] }}</div>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p style="color:#94a3b8;">Chunk details will appear after the chunking stage emits data.</p>
        {% endif %}
      </article>
    </div>
  {% endif %}

  <section>
    <h4>Stage breakdown</h4>
    <div class="stage-grid">
      {% for stage_name, stage_title in stage_sequence %}
        {% set stage = run.get_stage(stage_name) %}
        <article class="stage-card" data-stage-id="{{ stage_name }}" style="opacity: {{ 1 if stage else 0.6 }};">
          <div class="stage-header">
            <div class="stage-number">{{ loop.index }}</div>
            <div>
              <h5 style="margin:0;font-size:1.1rem;">{{ stage.title if stage else stage_title }}</h5>
              <p style="margin:2px 0 0;font-size:0.85rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.2em;">{{ stage_name }}</p>
            </div>
            {% if stage and stage.duration_ms %}
              <span style="margin-left:auto;font-size:0.85rem;color:#94a3b8;">{{ '%.0f'|format(stage.duration_ms) }} ms</span>
            {% else %}
              <span style="margin-left:auto;font-size:0.85rem;color:#94a3b8;">Pending…</span>
            {% endif %}
            {% if stage %}
              <button class="stage-toggle" type="button">Collapse</button>
            {% endif %}
          </div>
          {% if stage %}
            <div class="stage-content expanded">
              <div class="stage-output-wrapper">
                <button class="copy-button" type="button">Copy</button>
                <div class="stage-output-container">
                  <pre>{{ stage.details | tojson(indent=2) }}</pre>
                </div>
              </div>
              {% if stage.name == "parsing" %}
                <div style="margin-top:16px;font-size:0.9rem;">
                  <p style="color:#e0f2fe;margin-bottom:12px;">
                    <strong>Pages parsed:</strong> {{ stage.details.page_count }}
                  </p>
                  {% if stage.details.pages %}
                    <div style="display:flex;flex-direction:column;gap:16px;">
                      {% for page in stage.details.pages %}
                        <div style="border:1px solid rgba(148,163,184,0.2);border-radius:8px;padding:12px;background:rgba(30,41,59,0.5);">
                          <div style="font-weight:600;color:#e0f2fe;margin-bottom:8px;">
                            Page {{ page.page_number }}
                            {% if page.component_count %}
                              · {{ page.component_count }} components
                              {% if page.component_summary %}
                                ({{ page.component_summary.text }} text, {{ page.component_summary.image }} images, {{ page.component_summary.table }} tables)
                              {% endif %}
                            {% endif %}
                          </div>
                          {% if page.components %}
                            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:400px;overflow-y:auto;">
                              {% for component in page.components[:20] %}
                                <div style="padding:8px;background:rgba(15,23,42,0.6);border-radius:4px;border-left:3px solid {% if component.type == 'text' %}#34d399{% elif component.type == 'image' %}#60a5fa{% else %}#f59e0b{% endif %};">
                                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                    <span style="font-size:0.75rem;color:#94a3b8;text-transform:uppercase;font-weight:600;">{{ component.type }}</span>
                                    <span style="font-size:0.75rem;color:#64748b;">order: {{ component.order }}</span>
                                  </div>
                                  {% if component.type == 'text' %}
                                    <div style="color:#e0f2fe;font-size:0.85rem;white-space:pre-wrap;word-break:break-word;">
                                      {{ component.text[:200] }}{% if component.text|length > 200 %}…{% endif %}
                                    </div>
                                    {% if component.text_type %}
                                      <div style="font-size:0.75rem;color:#94a3b8;margin-top:4px;">Type: {{ component.text_type }}</div>
                                    {% endif %}
                                  {% elif component.type == 'image' %}
                                    <div style="color:#cbd5e1;font-size:0.85rem;">{{ component.description[:150] }}{% if component.description|length > 150 %}…{% endif %}</div>
                                    {% if component.recognized_text %}
                                      <div style="color:#94a3b8;font-size:0.75rem;margin-top:4px;font-style:italic;">
                                        Recognized text: {{ component.recognized_text[:100] }}{% if component.recognized_text|length > 100 %}…{% endif %}
                                      </div>
                                    {% endif %}
                                  {% elif component.type == 'table' %}
                                    {% if component.caption %}
                                      <div style="color:#e0f2fe;font-weight:600;margin-bottom:4px;">{{ component.caption }}</div>
                                    {% endif %}
                                    <div style="color:#cbd5e1;font-size:0.85rem;">
                                      {{ component.rows|length }} rows
                                      {% if component.rows %}
                                        · Columns: {{ component.rows[0].keys()|list|join(', ') }}
                                      {% endif %}
                                    </div>
                                  {% endif %}
                                </div>
                              {% endfor %}
                              {% if page.components|length > 20 %}
                                <div style="color:#94a3b8;font-size:0.85rem;text-align:center;padding:8px;">
                                  ... {{ page.components|length - 20 }} more components (see JSON output)
                                </div>
                              {% endif %}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% elif stage.name == "enrichment" %}
                <p style="font-size:0.9rem;color:#e0f2fe;">
                  Document summary:
                  {% if stage.details.document_summary %}
                    "{{ stage.details.document_summary }}"
                  {% else %}
                    Not available yet.
                  {% endif %}
                </p>
              {% elif stage.name == "cleaning" %}
                <p style="font-size:0.9rem;color:#e0f2fe;">Profile: {{ stage.details.profile }}</p>
              {% elif stage.name == "vectorization" %}
                <p style="font-size:0.9rem;color:#e0f2fe;">Vector dimension: {{ stage.details.vector_dimension }}</p>
              {% endif %}
            </div>
          {% else %}
            <div class="stage-content expanded">
              <p style="color:#94a3b8;font-size:0.9rem;">Waiting for {{ stage_title }}…</p>
            </div>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  </section>

  <section style="font-size:0.9rem;color:#94a3b8;">
    <h4>Need more fidelity?</h4>
    <p style="margin-top:6px;">
      Extend any pipeline stage and emit additional metadata; the dashboard automatically surfaces it in the numbered cards as
      soon as the stage completes.
    </p>
  </section>
</div>
